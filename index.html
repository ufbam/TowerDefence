<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoTD — Single‑File Tower Defense (No Assets)</title>
  <style>
    :root {
      --bg: #0f1222;
      --panel: #12162b;
      --panel-2: #0b0e1c;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #5eead4;
      --danger: #f472b6;
      --good: #a7f3d0;
      --warn: #fbbf24;
      --grid: #1f2548;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 65% 40%, #101533 0%, var(--bg) 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      user-select: none;
      overflow: hidden;
    }
    .wrap {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto 1fr;
      gap: 0;
      height: 100%;
    }
    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.0));
      border-bottom: 1px solid #202646;
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: 0.5px; font-weight: 700; }
    header .meta { display: flex; gap: 16px; align-items: center; font-size: 14px; }
    header .pill { padding: 6px 10px; border-radius: 999px; background: #12183a; border: 1px solid #1e2655; }

    aside {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border-right: 1px solid #202646;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* single column toolbar so it never overlays gameplay */
    .toolbar { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .btn {
      display: flex; align-items: center; gap: 10px;
      padding: 8px; border: 1px solid #243065; border-radius: 12px;
      background: #0f1537; color: var(--text);
      cursor: pointer; transition: transform .06s ease, background .2s ease, border .2s ease;
    }
    .btn:hover { transform: translateY(-2px); background: #121a48; }
    .btn.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(94,234,212,.15) inset; }
    .btn .cost { margin-left: auto; color: var(--warn); font-weight: 700; }
    .btn canvas { border-radius: 8px; background: #0b0f2a; border: 1px solid #1b2452; }

    .panel { padding: 10px; border: 1px solid #1f274e; border-radius: 12px; background: #0b0f2a; }
    .label { font-size: 12px; color: var(--muted); }
    .stat { font-size: 30px; font-weight: 900; letter-spacing: .5px; }

    .actions { display: flex; gap: 8px; }
    .actions button, .mini button { flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #22306a; background: #0e1440; color: var(--text); cursor: pointer; }
    .actions button:hover, .mini button:hover { background: #141d5c; }

    .mini { display:flex; gap:8px; align-items:center; }
    .seg { display:flex; gap:6px; }
    .seg button { padding: 8px 10px; border-radius: 8px; border:1px solid #22306a; background:#0f1537; cursor:pointer; }
    .seg button.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(94,234,212,.15) inset; }

    .help { font-size: 12px; color: var(--muted); line-height: 1.5; }

    .canvas-wrap { position: relative; }
    canvas#game { display: block; width: 100%; height: calc(100vh - 56px); background:
      linear-gradient(90deg, transparent 49%, rgba(255,255,255,.025) 50%, transparent 51%) 0 0/40px 40px,
      linear-gradient(0deg, transparent 49%, rgba(255,255,255,.02) 50%, transparent 51%) 0 0/40px 40px,
      radial-gradient(1000px 800px at 60% 35%, rgba(94,234,212,.07), transparent 60%)
      ; }
    .toast { position: absolute; top: 14px; left: 14px; background: rgba(18,24,64,.9); padding: 8px 10px; font-size: 13px; border: 1px solid #22306a; border-radius: 8px; opacity: 0; transform: translateY(-6px); transition: all .25s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }

    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid #2a3872; background:#0d1340; }
    .red { color:#fecdd3; }
    .green { color:#bbf7d0; }
    .gold { color:#fde68a; }

    /* tower panel */
    .tpanel { position:absolute; min-width: 180px; background: rgba(12,16,48,.96); border:1px solid #23306a; border-radius: 10px; padding:10px; box-shadow: 0 8px 30px rgba(0,0,0,.3); pointer-events: auto; }
    .tpanel h4 { margin:0 0 6px; font-size:14px; }
    .tpanel .row { display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin:4px 0; }
    .tpanel .row strong { color: var(--text); }
    .tpanel .btns { display:flex; gap:6px; margin-top:6px; }
    .tpanel .btns button { flex:1; padding:6px 8px; border-radius:8px; border:1px solid #22306a; background:#0f1537; color:var(--text); cursor:pointer; }
    .tpanel .btns button:hover { background:#141d5c; }
    .hidden { display:none; }

    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; grid-template-rows: auto auto auto 1fr; }
      aside { grid-row: 2; }
      canvas#game { height: calc(100vh - 280px); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>GeoTD — Pure Canvas Tower Defense</h1>
      <div class="meta">
        <div class="pill">No images • No libs • Single file</div>
        <div class="pill">GitHub Pages ready</div>
        <div class="pill" id="version">v1.2.1</div>
      </div>
    </header>

    <aside>
      <div class="panel">
        <div class="label">Stats</div>
        <div style="display:flex; gap:18px; margin-top:6px; flex-wrap:wrap; align-items: baseline;">
          <div>
            <div class="label">Cash</div>
            <div class="stat" id="ui-cash">$0</div>
          </div>
          <div>
            <div class="label">Lives</div>
            <div class="stat" id="ui-lives">20</div>
          </div>
          <div>
            <div class="label">Waves</div>
            <div class="stat" id="ui-wave">0</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="label" style="margin-bottom:8px;">Build — click a tower, then click near (but not on) the path</div>
        <div class="toolbar" id="toolbar"></div>
      </div>

      <div class="panel actions">
        <button id="startWave" title="Waves are stackable">Start Wave</button>
        <button id="sellMode">Sell (S)</button>
      </div>

      <div class="panel mini">
        <div class="label" style="min-width:54px">Speed</div>
        <div class="seg">
          <button id="spd1" class="active">x1</button>
          <button id="spd2">x2</button>
          <button id="spd3">x3</button>
        </div>
        <button id="nextMap" style="margin-left:auto">Next Map</button>
      </div>

      <div class="panel mini">
        <button id="saveBtn">Save</button>
        <button id="loadBtn">Load</button>
        <button id="resetBtn">Reset</button>
      </div>

      <div class="panel help">
        <div><span class="badge gold">Tip</span> Waves are <b>stackable</b>. Start another any time to increase the chaos. Place towers outside the faint path corridor. Hold <b>R</b> to rotate before placing. Press <b>S</b> to toggle sell mode. Click a tower to <b>upgrade</b> it (or press <b>U</b>).</div>
        <div style="margin-top:6px;"><span class="badge">Keys</span> 1–5 select towers • <b>Space</b> start wave • <b>P</b> pause • <b>U</b> upgrade selected</div>
      </div>
    </aside>

    <div class="canvas-wrap">
      <canvas id="game"></canvas>
      <div class="toast" id="toast"></div>
      <div id="towerPanel" class="tpanel hidden"></div>
    </div>
  </div>

  <script>
/**
 * GeoTD — single‑file, no‑asset tower defense for GitHub Pages
 * Drop this file in a repo as `index.html` and enable GitHub Pages (root).
 *
 * v1.2.0 additions (non‑breaking):
 * - Speed controls x1/x2/x3
 * - Multiple maps (Next Map)
 * - Save/Load/Reset via localStorage
 * - Tower upgrades with on‑canvas panel + (U) hotkey (levels 1‑3)
 */

(() => {
  const GAME_VERSION = '1.2.1';
  const SAVE_KEY = 'geotd-save-v1';

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const ui = {
    cash: document.getElementById('ui-cash'),
    lives: document.getElementById('ui-lives'),
    wave: document.getElementById('ui-wave'),
    toolbar: document.getElementById('toolbar'),
    startWave: document.getElementById('startWave'),
    sellMode: document.getElementById('sellMode'),
    toast: document.getElementById('toast'),
    towerPanel: document.getElementById('towerPanel'),
    speedBtns: [document.getElementById('spd1'), document.getElementById('spd2'), document.getElementById('spd3')],
    nextMap: document.getElementById('nextMap'),
    saveBtn: document.getElementById('saveBtn'),
    loadBtn: document.getElementById('loadBtn'),
    resetBtn: document.getElementById('resetBtn'),
  };
  document.getElementById('version').textContent = 'v'+GAME_VERSION;

  // --- Colors ---
  const COLORS = {
    enemy: ['#60a5fa','#34d399','#f472b6','#f59e0b','#a78bfa','#fb7185'],
    path: '#22306a',
    startHole: '#0ea5e9',
    endHole: '#f43f5e',
    hpGood: '#22c55e',
    hpMid: '#fbbf24',
    hpLow: '#ef4444',
    range: 'rgba(59,130,246,0.12)'
  };

  // --- Game State (declare BEFORE resize to avoid early-reference bugs) ---
  const state = {
    cash: 150,
    lives: 20,
    wavesStarted: 0,
    playing: true,
    building: null, // tower type key
    buildRotation: 0,
    sellMode: false,
    speed: 1,
    enemies: [],
    towers: [],
    projectiles: [],
    beams: [],   // laser beams {x1,y1,x2,y2,ttl,color,width}
    zaps: [],    // lightning polylines [{pts:[{x,y}..],ttl,color}]
    path: [],
    pathWidth: 38,
    spawners: [], // multiple concurrent waves
    mouse: {x:0,y:0,down:false},
    selectedTower: null,
    mapIndex: 0,
  };

  // --- Maps defined BEFORE resize/generatePath ---
  const Maps = [
    { name: 'Snake', build() { const w = canvas.clientWidth, h = canvas.clientHeight, margin = 80, bands = 6; const pts=[]; for (let i=0;i<=bands;i++){ const y=margin + (h - margin*2) * (i/bands); const x = i%2===0?margin:w-margin; const wob = (i===0||i===bands)?0:(i%2===0?1:-1)*40; pts.push({x:x+wob,y}); } return pts; } },
    { name: 'Diagonal Zig', build(){ const w=canvas.clientWidth, h=canvas.clientHeight, margin=70; const pts=[], steps=7; for(let i=0;i<=steps;i++){ const t=i/steps; const x=margin+(w-2*margin)*t; const y=margin+(h-2*margin)*((i%2)?0.2:0.8); pts.push({x,y}); } return pts; } },
    { name: 'Wide S‑Curve', build(){ const w=canvas.clientWidth, h=canvas.clientHeight, m=70, midY=h/2; const pts=[], bends=5; for(let i=0;i<=bends;i++){ const t=i/bends; const x=m+(w-2*m)*t; const y= midY + Math.sin(t*Math.PI*2 - Math.PI/2)*(h*0.28); pts.push({x,y}); } return pts; } },
  ];

  function generatePath(){ state.path = Maps[state.mapIndex].build(); }

  // --- Responsive canvas ---
  function resize() {
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width = Math.floor(canvas.clientWidth * dpr);
    canvas.height = Math.floor(canvas.clientHeight * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    // Only rebuild path after state & maps exist
    generatePath();
  }
  const ro = new ResizeObserver(resize); ro.observe(canvas);
  resize();

  // --- Helpers ---
  function lerp(a,b,t){ return a + (b-a)*t; }
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function pointSegDist(px, py, ax, ay, bx, by) { const vx = bx - ax, vy = by - ay; const wx = px - ax, wy = py - ay; const c1 = vx*wx + vy*wy; if (c1 <= 0) return Math.hypot(px-ax, py-ay); const c2 = vx*vx + vy*vy; if (c2 <= c1) return Math.hypot(px-bx, py-by); const t = c1 / c2; const projx = ax + t*vx, projy = ay + t*vy; return Math.hypot(px - projx, py - projy); }
  function distToPath(x,y){ let best = Infinity; for (let i=0;i<state.path.length-1;i++){ const a=state.path[i], b=state.path[i+1]; best = Math.min(best, pointSegDist(x,y,a.x,a.y,b.x,b.y)); } return best; }

  // --- Enemies ---
  const ENEMY_BASE_SPEED = 0.7;
  const ENEMY_TYPES = [
    { name:'Circle',  shape:'circle',  hp: 36, speed: 1.00, reward: 8 },
    { name:'Hex',     shape:'hex',     hp: 48, speed: 0.95, reward: 10 },
    { name:'Star',    shape:'star',    hp: 28, speed: 1.20, reward: 7 },
    { name:'Diamond', shape:'diamond', hp: 60, speed: 0.85, reward: 12 },
  ];
  function makeEnemyForWave(waveNum) { const type = ENEMY_TYPES[(Math.random()*ENEMY_TYPES.length)|0]; const hp = Math.round(type.hp * (1 + (waveNum-1)*0.35)); const speed = ENEMY_BASE_SPEED * type.speed * (1 + (waveNum-1)*0.05); const color = COLORS.enemy[(Math.random()*COLORS.enemy.length)|0]; return { type, color, x: state.path[0].x, y: state.path[0].y, seg: 0, t: 0, hp, maxHp: hp, slow: 0, slowTimer: 0, alive: true }; }
  function moveEnemy(e) { const speedFactor = e.slow>0 ? (1 - e.slow) : 1; let spd = speedFactor * (e.type.speed) * ENEMY_BASE_SPEED * 1.4; let remaining = spd; while (remaining > 0 && e.seg < state.path.length-1) { const a = state.path[e.seg], b = state.path[e.seg+1]; const ax=a.x, ay=a.y, bx=b.x, by=b.y; const vx = bx-ax, vy=by-ay; const L = Math.hypot(vx,vy) || 1; const step = Math.min(remaining, (1 - e.t) * L); const t2 = e.t + step / L; e.x = lerp(ax,bx,t2); e.y = lerp(ay,by,t2); e.t = t2; if (e.t >= 1 - 1e-6) { e.seg++; e.t = 0; } remaining -= step; } if (e.slowTimer>0) { e.slowTimer--; if (e.slowTimer<=0){ e.slow=0; } } if (e.seg >= state.path.length-1) { e.alive = false
  </script>
</body>
</html>
